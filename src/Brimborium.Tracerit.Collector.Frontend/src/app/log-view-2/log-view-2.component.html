<div class="log-view-2-container" #logView2Container>
  <!-- TimeScale Panel -->
  <section class="timescale-panel">
    <app-time-scale-2 [selectedLogLineId]="selectedLogLineId()" [highlightedLogLineId]="highlightedLogLineId()"
      [visibleRange]="visibleRange()" (logLineClick)="onSelectLogLine($event)"
      (logLineHover)="onHighlightLogLine($event)" />
  </section>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Grid Panel with Virtual Scroll -->
    <section class="grid-panel">
      @let listHeaders = (listCurrentHeader$ | async) ?? [];
      @let listLogLines = (listLogLineFiltered$ | async) ?? [];

      <!-- Header Row -->
      <div class="grid-header" cdkDropList cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="onDropHeader($event)" [style.width.px]="gridHeaderWidth()">
        <div class="header-cell sticky-col" id="header-id" [style]="headerId()?.headerCellStyle ?? {}">
          <div style="display: flex; flex:1; justify-content: space-between;"
            [cdkContextMenuTriggerFor]="contextMenuId">
            Id
            <lucide-icon [img]="Menu" size="14" />
          </div>
          <div class="resize-handle" (mousedown)="onResizeStart($event, headerId())"></div>
          <ng-template #contextMenuId>
            <div class="context-menu" cdkMenu>
              <button class="context-menu-item" cdkMenuItem (click)="toggleFilter()">Filter</button>
              <button class="context-menu-item" cdkMenuItem (click)="resetRange()">Reset Range</button>
              <button class="context-menu-item" cdkMenuItem (click)="showAllFieldsInDetails()">Reorder Details</button>
            </div>
          </ng-template>
        </div>
        @for (header of listHeaders; track header.id) {
        <div class="header-cell" [id]="'header-' + header.id" [style]="header.headerCellStyle"
          [style.transform]="gridHeaderTransform()" (dblclick)="onAutoSize(header)">
          <div class="header-content" cdkDrag>
            <lucide-icon [img]="GripVertical" size="14" class="drag-handle" cdkDragHandle />
            <span class="header-name">{{ header.name }}</span>
            @if (header.filter) {
            <button class="filter-btn active" (click)="removeFilter(header)" title="Remove filter">
              <lucide-icon [img]="FunnelX" size="14" />
            </button>
            }
          </div>
          <div class="resize-handle" (mousedown)="onResizeStart($event, header)"></div>
        </div>
        }
      </div>

      @if(showFilter()) {
      <div class="grid-filter">
        <div>Filter</div>
        <div>show condition filter here</div>

        <div>Highlight</div>
        <div>show condition highlight here</div>

        <div>Traces</div>
        <div class="trace-list">
          @for (traceInformation of filterListTraceInformation(); track traceInformation.traceId) {
            <svg #svgElement width="displayWidth()" height="4px" style="z-index: 16;">
              <line x1="0" y1="0" [attr.x2]="traceInformation.xStart" y2="4" fill="#ffcccc" stroke="fuchsia" stroke-width="2" />
              <line [attr.x1]="traceInformation.xStart" y1="0" [attr.x2]="1+traceInformation.xFinish" y2="4" fill="black" stroke="#ffcccc" stroke-width="4"/>
              <line [attr.x1]="traceInformation.xFinish" y1="0" [attr.x2]="displayWidth()" y2="4" fill="fuchsia" stroke="#ccccff" stroke-width="2"/>
            </svg>
          <div class="trace-item" (click)="selectTrace(traceInformation)">            
            <div class="trace-cell-cnt">
              {{traceInformation.listLogLineId.length}}
            </div>
            <div class="trace-cell-traceId">
              {{traceInformation.traceId}}
            </div>
            <div class="trace-cell-dt">
              {{traceInformation.logLineFirst?.ts?.toString()}}
            </div>
            <div class="trace-cell-dt">
              {{traceInformation.logLineLast?.ts?.toString()}}
            </div>
          </div>
          }
        </div>
      </div>
      }

      <!-- Virtual Scroll Body -->
      <cdk-virtual-scroll-viewport [itemSize]="rowHeight" class="grid-body"
        (scrolledIndexChange)="onScrollIndexChange()">
        <div *cdkVirtualFor="let logLine of listLogLines; trackBy: trackByLogLine" class="grid-row"
          [class.selected]="isSelected(logLine)" [class.highlighted]="isHighlighted(logLine)"
          (click)="onSelectLogLine(logLine)" (mouseenter)="onHighlightLogLine(logLine)"
          (mouseleave)="onHighlightLogLine(null)">
          <div class="data-cell sticky-col" [style]="headerId()?.headerCellStyle ?? {}">
            <span class="log-id">{{ logLine.id }}</span>
            <span class="time-diff">{{ getTimeDiff(logLine) }}</span>
          </div>
          @for (header of listHeaders; track header.id) {
          <div class="data-cell" [style]="header.dataCellStyle"
            (contextmenu)="addFilter(logLine, header); $event.preventDefault()">
            {{ getContent(logLine, header) }}
          </div>
          }
        </div>
      </cdk-virtual-scroll-viewport>
    </section>

  </div>
  <div>

    <!-- Details Panel -->
    <section class="details-panel">
      @let selected = selectedLogLine();
      @if (selected) {
      <div class="header-content" cdkDropList #detailsHeader="cdkDropList" [cdkDropListData]="detailsHeaderContent()"
        [cdkDropListConnectedTo]="[detailsBody]" (cdkDropListDropped)="dropDetailsContent($event)">
        <h3>Log Details<br /> (ID: {{ selected.id }})</h3>
        @for (item of detailsHeaderContent(); track item.name) {
        <div class="detail-item">
          <label cdkDrag (dblclick)="onToggleColumnByName(item.name)">{{ item.name }}:</label>
          <span class="detail-value">{{ item.value }}</span>
        </div>
        }
      </div>
      <div class="details-content" cdkDropList #detailsBody="cdkDropList" [cdkDropListData]="detailsBodyContent()"
        [cdkDropListConnectedTo]="[detailsHeader]" (cdkDropListDropped)="dropDetailsContent($event)">
        @for (item of detailsBodyContent(); track item.name) {
        <div class="detail-item">
          <label cdkDrag (dblclick)="onToggleColumnByName(item.name)">{{ item.name
            }}:{{item.header.show?'*':''}}</label>
          <span class="detail-value">{{ item.value }}</span>
        </div>
        }
      </div>
      } @else {
      <div class="no-selection">
        <p>Select a log entry to view details</p>
      </div>
      }
    </section>
  </div>

  <!-- Stats Bar -->
  <footer class="stats-bar">
    <span>Total: {{ (logTimeDataService.listLogLineAll$ | async)?.length ?? 0 }}</span>
    <span>Filtered: {{ (logTimeDataService.listLogLineFilteredCondition$ | async)?.length ?? 0 }}</span>
  </footer>
</div>